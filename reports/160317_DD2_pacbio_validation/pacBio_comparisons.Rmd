library(knitr)
library(ggplot2)
```{r setup}
opts_chunk$set(fig.width=13, fig.height=8)


``` 

```{r}
access <- read.table("DD2-2D4.align_cf.3D7_DD2.ACCESS.bed",stringsAsFactors = F)
colnames(access) <- c("chrom","st","en","var","IS","TD","VT","VC","LD","N1","C1","L1","NM1","N2","C2","L2","MN2")
access$Imatch <- (access$IS == (access$L2-access$L1))

sum(access$VC==1)
sum(access$VC==1 & access$Imatch)
sum(access$VC==1 & access$Imatch) / sum(access$VC==1)

```


```{r}
inaccess <- read.table("DD2-2D4.align_cf.3D7_DD2.INACCESS.bed",stringsAsFactors = F)
colnames(inaccess) <- c("chrom","st","en","var","IS","TD","VT","VC","LD","N1","C1","L1","NM1","N2","C2","L2","MN2")
inaccess$Imatch <- (inaccess$IS == (inaccess$L2-inaccess$L1))

sum(inaccess$VC==1)
sum(inaccess$VC==1 & inaccess$Imatch)
sum(inaccess$VC==1 & inaccess$Imatch) / sum(inaccess$VC==1)


```



```{r}
allvars <- read.table("DD2-2D4.align_cf.3D7_DD2.bed",stringsAsFactors = F)
colnames(allvars) <- c("chrom","st","en","var","IS","TD","VT","VC","LD","N1","C1","L1","NM1","N2","C2","L2","MN2")
allvars$Imatch <- (allvars$IS == (allvars$L2-allvars$L1))

sum(allvars$VC==1)
sum(allvars$VC==1 & allvars$Imatch)
sum(allvars$VC==1 & allvars$Imatch) / sum(allvars$VC==1)
#sum(allvars$VC!=1 & allvars$Imatch) / sum(allvars$VC!=1)

allvars$accessible = allvars$var %in% access$var
allvars$noFVars = allvars$VC==1

#predicted/aligned length differences (accessible vs inaccessible genome)
ggplot(subset(allvars,VC==1),aes(x=IS,y=L2-L1,colour=Imatch)) + geom_point() + facet_grid(accessible ~ .) + xlim(-100,100)

#predicted insert length distribution (accessible vs inaccessible)
ggplot(subset(allvars,VC==1),aes(x=IS,fill=Imatch)) + geom_bar() + facet_grid(accessible ~ .,scale="free_y") + xlim(-100,100)

#insert calling better than del, both unmatched > 20bp
ggplot(subset(allvars,Imatch & noFVars),aes(x=IS,fill=accessible)) + geom_bar()

ggplot(subset(allvars,noFVars),aes(x=IS,fill=Imatch)) + geom_bar(position="fill") + xlim(-50,50)
ggplot(subset(allvars,noFVars),aes(x=IS,fill=Imatch)) + geom_bar() + xlim(-50,50)


ggplot(subset(allvars,VC==1),aes(x=TD,y=IS-(L2-L1),colour=Imatch)) + geom_point() + facet_grid(accessible ~ .)


```

```{r}

allvars$mid <- allvars$en-(allvars$en-allvars$st)/2
allvars$block = round(allvars$mid/5000)

blockcf <- data.frame("chrom"=aggregate(allvars$chrom,list(paste(allvars$chrom,allvars$block)),FUN=unique)[[2]],
            "mid"=aggregate(allvars$mid,list(paste(allvars$chrom,allvars$block)),FUN=mean)[[2]],
            "block"=aggregate(allvars$block,list(paste(allvars$chrom,allvars$block)),FUN=unique)[[2]],
            "access"=aggregate(allvars$accessible,list(paste(allvars$chrom,allvars$block)),FUN=sum)[[2]],
            "match"=aggregate(allvars$Imatch,list(paste(allvars$chrom,allvars$block)),FUN=sum)[[2]],
            "total"=aggregate(allvars$Imatch,list(paste(allvars$chrom,allvars$block)),FUN=length)[[2]])
blockcf$matchpc = blockcf$match/blockcf$total
blockcf$accesspc = blockcf$access/blockcf$total
blockcf <- subset(blockcf,accesspc==1)

head(blockcf)
ggplot(blockcf,aes(x=mid,y=matchpc,colour=accesspc)) + geom_point() + facet_grid(chrom ~ .)

#ggplot(blockcf,aes(x=mid,y=match)) + geom_line(colour="red") + geom_line(aes(y=total)) + facet_grid(chrom ~ .)
ggplot(blockcf,aes(x=mid,y=match)) + geom_point(colour="red") + geom_point(aes(y=total)) + facet_grid(chrom ~ .)

```
