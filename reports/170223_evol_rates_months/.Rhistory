setwd("/Volumes//gsap_garage-protistvector/sredmond/broad_10Xmicrobial/reports/160824_snr_snp_LDs/")
knit("snpLDReport.Rmd")
library(knitr)
knit("snpLDReport.Rmd")
knit("snpLDReport.Rmd")
plotmatrix(ld55,aes())
library(ggplot2)
library(hexbin)
library(reshape2)
library(knitr)
library(gridExtra)
library(grid)
library(ggplot2)
library(lattice)
```{r setup}
opts_chunk$set(fig.width=12, fig.height=8,dev='png',warning=F)
```
```{r}
ld55 <- read.table("HuMal900505.vcf.gz.bx.2.Pf3D7_09_v31000000-1500000.ld",header=F,stringsAsFactors=F)
ld55$sample="0505"
ld91 <- read.table("HuMal900505.vcf.gz.bx.2.Pf3D7_09_v31000000-1500000.ld",header=F,stringsAsFactors=F)
ld91$sample="0901"
ld <- rbind(ld91,ld55)
posns = read.table("HuMal900505.vcf.gz.bx.2.Pf3D7_09_v31000000-1500000.map")[,4]
colnames(ld55)<-posns
rownames(ld55)<-posns
melt(ld55)
ggplot(ld,aes(x=SNP_A,y=SNP_B,colour=R2)) + geom_tile() + facet_grid(. ~ sample)
head(ld)
ldm <- melt(ld55)
head(ldm)
plotmatrix(ld55,aes())
library(ggplot2)
plotmatrix(ld55,aes())
ldm
ldm <- melt(ld)
head(ld)
setwd("~/Gits/pfdisco/reports/170223_evol_rates_months/")
knit("evol_rate.Rmd")
library(ape)
library(ape)
library(adegenet)
library(ape)
library(adegenet)
library(knitr)
library(igraph)
library(RColorBrewer)
library(gridExtra)
opts_chunk$set(fig.width=9, fig.height=9)
opts_chunk$set(dev=c('png','postscript'))
knit("evol_rate.Rmd")
knit("evol_rate.Rmd")
library(ape)
library(adegenet)
library(knitr)
library(igraph)
library(RColorBrewer)
library(gridExtra)
opts_chunk$set(fig.width=9, fig.height=9)
opts_chunk$set(dev=c('png','postscript'))
warnings()
sym <- function(M) {
M[lower.tri(M)] = t(M)[lower.tri(M)]
M
}
makeNet <- function(distance_matrix, meta_file, ngroups=3) {
if (class(distance_matrix)=="dist") {
D = distance_matrix
mat <- as.matrix(D)
} else {
mat <- read.table(distance_matrix,sep="\t")
D <- as.dist(sym(mat))
}
clust <- gengraph(D,ngrp=3)
names <- colnames(mat)
mat <- as.matrix(mat)
meta <- read.table("Thies_metadata_1701.txt",sep="\t",header=T)
colnames(meta)[1]<-"name"
meta <- meta[!is.na(meta$Age),]
rownames(meta) <- meta$name
meta <- meta[names,]
coll <- as.Date(as.character(meta$Date),"%d/%m/%Y",origin = "2000-01-01")
#coll <- as.Date(paste("1","jan",meta$year,sep=""),"%d%b%Y")
names(coll)<-meta$name
meta$year <- as.numeric(format(coll,'%Y'))+2000
#   meta <- read.table("daniels.thies.CA.txt",sep="\t",header=T)
#   rownames(meta) <- meta$name
#   meta <- meta[names,]
#   coll <- as.Date(paste("1","jan",meta$year,sep=""),"%d%b%Y")
#   names(coll)<-meta$name
name1 <- names[clust$clust$membership==1]
name2 <- names[clust$clust$membership==2]
name3 <- names[clust$clust$membership==3]
year1 <- meta$year[clust$clust$membership==1]
year2 <- meta$year[clust$clust$membership==2]
year3 <- meta$year[clust$clust$membership==3]
coll1 <- coll[name1]
coll2 <- coll[name2]
coll3 <- coll[name3]
dist1 <- mat[name1,name1]
dist2 <- mat[name2,name2]
dist3 <- mat[name3,name3]
res1 <- seqTrack(dist1, x.names=name1, x.dates=coll1)
res2 <- seqTrack(dist2, x.names=name2, x.dates=coll2)
res3 <- seqTrack(dist3, x.names=name3, x.dates=coll3)
res1$year <- year1
res2$year <- year2
res3$year <- year3
res1$name <- name1
res2$name <- name2
res3$name <- name3
list(res1,res2,res3)
}
knit("evol_rate.Rmd")
getqd()
getwd()
warnings()
getwd()
knit("evol_rate.Rmd")
library(ape)
library(adegenet)
library(knitr)
library(igraph)
library(RColorBrewer)
library(gridExtra)
opts_chunk$set(fig.width=9, fig.height=9)
opts_chunk$set(dev=c('png','postscript'))
sym <- function(M) {
M[lower.tri(M)] = t(M)[lower.tri(M)]
M
}
makeNet <- function(distance_matrix, meta_file, ngroups=3) {
if (class(distance_matrix)=="dist") {
D = distance_matrix
mat <- as.matrix(D)
} else {
mat <- read.table(distance_matrix,sep="\t")
D <- as.dist(sym(mat))
}
clust <- gengraph(D,ngrp=3)
names <- colnames(mat)
mat <- as.matrix(mat)
meta <- read.table("Thies_metadata_1701.txt",sep="\t",header=T)
colnames(meta)[1]<-"name"
meta <- meta[!is.na(meta$Age),]
rownames(meta) <- meta$name
meta <- meta[names,]
coll <- as.Date(as.character(meta$Date),"%d/%m/%Y",origin = "2000-01-01")
#coll <- as.Date(paste("1","jan",meta$year,sep=""),"%d%b%Y")
names(coll)<-meta$name
meta$year <- as.numeric(format(coll,'%Y'))+2000
#   meta <- read.table("daniels.thies.CA.txt",sep="\t",header=T)
#   rownames(meta) <- meta$name
#   meta <- meta[names,]
#   coll <- as.Date(paste("1","jan",meta$year,sep=""),"%d%b%Y")
#   names(coll)<-meta$name
name1 <- names[clust$clust$membership==1]
name2 <- names[clust$clust$membership==2]
name3 <- names[clust$clust$membership==3]
year1 <- meta$year[clust$clust$membership==1]
year2 <- meta$year[clust$clust$membership==2]
year3 <- meta$year[clust$clust$membership==3]
coll1 <- coll[name1]
coll2 <- coll[name2]
coll3 <- coll[name3]
dist1 <- mat[name1,name1]
dist2 <- mat[name2,name2]
dist3 <- mat[name3,name3]
res1 <- seqTrack(dist1, x.names=name1, x.dates=coll1)
res2 <- seqTrack(dist2, x.names=name2, x.dates=coll2)
res3 <- seqTrack(dist3, x.names=name3, x.dates=coll3)
res1$year <- year1
res2$year <- year2
res3$year <- year3
res1$name <- name1
res2$name <- name2
res3$name <- name3
list(res1,res2,res3)
}
```{r}
ifile <- "Thies_all_manual.PASS.Cls.miss0.5.LMRG.HAP.INDEL.recode.vcf.dist.tab.txt"
sfile <- "Thies_all_manual.PASS.Cls.miss0.5.LMRG.HAP.SNP.recode.vcf.dist.tab.txt"
corefile <- "Thies_all_manual.PASS.Cls.miss0.5.LMRG.HAP.CALLBOTH.vcf.dist.tab.txt"
distmatS <- as.dist(sym(read.table(sfile,sep="\t")))
distmatI <- as.dist(sym(read.table(ifile,sep="\t")))
distmatIS <- distmatS+distmatI
distmatCore <- as.dist(sym(read.table(corefile,sep="\t")))
indelNets <- makeNet(distmatI)
snpNets <- makeNet(distmatS)
varNets <- makeNet(distmatIS)
printGraph <- function(graph,colours,title) {
cols <- brewer.pal((max(graph$year)-min(graph$year))+1, colours)
ts=1 #textsize
ig <- as.igraph(graph)
tree <- layout_as_tree(ig,flip.y = F)[,c(2,1)]
V(ig)$name <- graph$name
V(ig)$color <- cols[graph$year-min(graph$year)+1]
V(ig)$label.cex <- ts
#frame()
plot(ig,layout=tree,main=title,vertex.size=25,
edge.color="black",edge.label.cex=1.5,edge.label.family="Helvetica",vertex.label.family="Helvetica")
}
printGraph(varNets[[1]],"Greens","clade 29 all vars")
opts_chunk$set(fig.width=12, fig.height=9)
opts_chunk$set(dev=c('png'))
net <- varNets[[1]]
indDists <- as.matrix(distmatI)
snpDists <- as.matrix(distmatS)
coreDists <- as.matrix(distmatCore)
net$direct<-T
netAll <- net
getAnces <- function(net, leaf, ids=character()) {
id = ids[1]
ances = netAll[id,"ances"]
date = netAll[id,"date"]
ances.date = netAll[id,"ances.date"]
#    if(is.na(steps)) {steps = netAll[id,"steps"]} else {write(steps,stderr())}
#write(paste(leaf,id,ances,sep="\t"),stderr())
if (!is.na(ances)) {
if (id != leaf) {
leaf.date = net[leaf,"date"]
leaf.year = net[leaf,"year"]
leaf.name = net[leaf,"name"]
nextI = dim(net)[[1]]+1
#        write(paste("  adding",nextI,":",leaf,ances,sep=" "),stderr())
net[nextI,1:2] <- c(leaf, ances)
net[nextI,4] <- leaf.date
net[nextI,5] <- ances.date
net[nextI,6] <- leaf.year
net[nextI,7] <- leaf.name
net[nextI,8] <- F
}
net <- getAnces(net,leaf,c(ances))
}
if (length(ids) > 1){
ids <- ids[ids != id]
#       write(paste("proceeding:",ids[1],sep=" "),stderr())
net <- getAnces(net,ids[1],ids)
#       steps <- steps+1
#       net <- getAnces(net,ids[1],ids,steps)
}
net
}
getAnces(net,net$id[1],net$id)
getEvolRates <- function(net,mat,ng) {
netAll <- getAnces(net, net$id[1],net$id)
D <- as.dist(sym(mat))
names <- colnames(mat)
mat <- as.matrix(sym(mat))
outgroups <- setdiff(names,net$name)
outtab <- data.frame(from=character(),
to=character(),
out=character(),
time=integer(),
years=integer(),
distance=numeric(),
rate=numeric(),
#    direct=logical(),
stringsAsFactors=FALSE)
for (i in c(1:dim(netAll)[[1]])) {
if(!is.na(netAll$ances[i])) {
sample = netAll$name[i]
ances = netAll$name[netAll$ances[i]]
#isdirect <- netAll$direct[i]
dists = c()
#time elapsed in years
#time <- as.integer(netAll$year[i] - netAll$year[netAll$ances[i]])
years <- as.integer(netAll$year[i] - netAll$year[netAll$ances[i]])
#time elapsed in months
time <- round(as.integer(netAll$date[i]-netAll$ances.date[i])*12/365,2)
for (o in outgroups) {
dist <- mat[sample,o]-mat[ances,o]
dists <- c(dists, dist)
outtab[dim(outtab)[1]+1,1:3]=c(ances,sample,o)
outtab[dim(outtab)[1],4:7]=c(time,years,dist,round(dist/time,2))
#outtab[dim(outtab)[1],8]=isdirect
}
dists <- round(dists/time)
#paste(dists,collapse = ","),
#write(paste(ances,sample,netAll$date[i],netAll$ances.date[i],time,round(mean(dists),2),round(sd(dists),2),sep="\t"),stdout())
#      write(paste(ances,sample,outgroups,time,dists,sep="\t"),stdout())
}
}
outtab$pair <- paste(outtab$from,outtab$to)
outtab
}
test <- getEvolRates(varNets[[1]],indDists)
g_legend<-function(a.gplot){
tmp <- ggplot_gtable(ggplot_build(a.gplot))
leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
legend <- tmp$grobs[[leg]]
return(legend)}
opts_chunk$set(fig.width=18, fig.height=8)
opts_chunk$set(dev=c('png','postscript'))
ir1 <- getEvolRates(varNets[[1]],indDists)
sr1 <- getEvolRates(varNets[[1]],snpDists)
isr1 <- getEvolRates(varNets[[1]],indDists+snpDists)
iplot <- ggplot(subset(ir1,years>0),aes(x=years,y=rate)) +
geom_boxplot(aes(group=years),fill=NA) + geom_hline(aes(yintercept=mean(rate,na.rm=T)),linetype=3) +
geom_point(aes(colour=to,shape=from),position=position_jitter(width=0.5),size=3)+
geom_label(aes(label=paste(round(mean(rate,na.rm=T),2)," (+/- ",round(sd(rate,na.rm=T),1),")",sep=""),y=mean(rate,na.rm=T),x=max(years)+0.3),size=5)+
ggtitle("indel rate, clade 2") + ylab("INDELs/mth/gen") + xlab("years")  + ylim(-2,9) + #xlim(0,7.5) +
theme(legend.position="none")
splot <- ggplot(subset(sr1,years>0),aes(x=years,y=rate)) +
geom_boxplot(aes(group=years),fill=NA) + geom_hline(aes(yintercept=mean(rate,na.rm=T)),linetype=3) +
geom_point(aes(colour=to,shape=from),position=position_jitter(width=0.5),size=3)+
geom_label(aes(label=paste(round(mean(rate,na.rm=T),2)," (+/- ",round(sd(rate,na.rm=T),1),")",sep=""),y=mean(rate,na.rm=T),x=max(years)+0.3),size=5)+
ggtitle("substitution rate, clade 2") + ylab("SNPs/mth/gen") + xlab("years") + ylim(-2,9) #+ xlim(0,7.5)
legend <- g_legend(splot)
grid.arrange(iplot, splot + theme(legend.position="none"),legend, nrow=1,widths=c(10,10,1),heights=c(1))
library(ggplot2)
knit("evol_rate.Rmd")
sppsubs$region
sppsubs$region <- factor(sppsubs$region,levels=c("all","accessible","inaccessible"),ordered=T)
ggplot(subset(sppsubs, Label %in% dotsubs),aes(x=gsize,y=subrate),) +
geom_polygon(data=ratesM,aes(group=variable,fill=variable)) +
scale_fill_manual(values = fcol) +
geom_label(aes(label=Label,colour=Group),nudge_x = 0.2) +
geom_point(aes(label=Pathogen,colour=Group,shape=vartype),size=5) +
scale_y_log10() + scale_x_log10(limits=c(1e3,1e8),breaks=c(1e4,1e5,1e6,1e7,1e8)) +
xlab("Genome Size (bp)")+ylab("mutation rate (muts / site / year)")+
theme(panel.background = element_rect(fill = F))
knit("evol_rate.Rmd")
knit("evol_rate.Rmd")
ggplot(subset(sppsubs,Label %in% barSamps),aes(x=Pathogen,y=subrate * gsize),) +
geom_bar(aes(alpha=region,fill=Group,colour=Group),stat = "identity",size=1) +
geom_label(data=subset(sppsubs,Label %in% labelSamps),aes(label=newmut))+
geom_label(data=subset(sppsubs,Label %in% midLabelSamps),aes(label=newmut, y=(subrate * gsize)/2))+
#  scale_alpha_manual(values=c("SNP"=0.9,"INDEL"=0.6,"SNP+INDEL"=1))+
scale_alpha_manual(values=c("all"=1,"accessible"=1,"inaccessible"=0.8))+
ylab("mutation rate (muts / genome / year)")+
theme(panel.background = element_rect(fill = F),axis.text.x = element_text(angle = 90, hjust = 1))
ggplot(subset(sppsubs,Label %in% barSamps),aes(x=Pathogen,y=subrate * gsize),) +
geom_bar(aes(alpha=region,fill=Group),stat = "identity",size=1) +
geom_label(data=subset(sppsubs,Label %in% labelSamps),aes(label=newmut))+
geom_label(data=subset(sppsubs,Label %in% midLabelSamps),aes(label=newmut, y=(subrate * gsize)/2))+
#  scale_alpha_manual(values=c("SNP"=0.9,"INDEL"=0.6,"SNP+INDEL"=1))+
scale_alpha_manual(values=c("all"=1,"accessible"=1,"inaccessible"=0.8))+
ylab("mutation rate (muts / genome / year)")+
theme(panel.background = element_rect(fill = F),axis.text.x = element_text(angle = 90, hjust = 1))
ggplot(subset(sppsubs,Label %in% barSamps),aes(x=Pathogen,y=subrate * gsize),) +
geom_bar(aes(alpha=region,fill=Group,colour=Group),stat = "identity",size=1) +
geom_label(data=subset(sppsubs,Label %in% labelSamps),aes(label=newmut))+
geom_label(data=subset(sppsubs,Label %in% midLabelSamps),aes(label=newmut, y=(subrate * gsize)/2))+
#  scale_alpha_manual(values=c("SNP"=0.9,"INDEL"=0.6,"SNP+INDEL"=1))+
scale_alpha_manual(values=c("all"=1,"accessible"=1,"inaccessible"=0.8))+
ylab("mutation rate (muts / genome / year)")+
theme(panel.background = element_rect(fill = F),axis.text.x = element_text(angle = 90, hjust = 1))
sppsubs
barSamps <- c("M. tuberculosis", "S. aureus (MRSA)","H. pylori",
"EBOV (Ebola)", "HIV-M",
"HFLUV (H1N1)","P.falciparum (core)", "P.falciparum (inacc)")
labelSamps <- c("M. tuberculosis", "S. aureus (MRSA)","H. pylori",
"EBOV (Ebola)", "HIV-M",
"HFLUV (H1N1)", "P.falciparum (all)")
midLabelSamps <- c("P.falciparum (inacc)",
"P.falciparum (core)")
ggplot(subset(sppsubs,Label %in% barSamps),aes(x=Pathogen,y=subrate * gsize),) +
geom_bar(aes(alpha=region,fill=Group,colour=Group),stat = "identity",size=1) +
geom_label(data=subset(sppsubs,Label %in% labelSamps),aes(label=newmut))+
geom_label(data=subset(sppsubs,Label %in% midLabelSamps),aes(label=newmut, y=(subrate * gsize)/2))+
#  scale_alpha_manual(values=c("SNP"=0.9,"INDEL"=0.6,"SNP+INDEL"=1))+
scale_alpha_manual(values=c("all"=1,"accessible"=1,"inaccessible"=0.8))+
ylab("mutation rate (muts / genome / year)")+
theme(panel.background = element_rect(fill = F),axis.text.x = element_text(angle = 90, hjust = 1))
dotsubs <- c("H. pylori", "M. tuberculosis", "S. aureus (MRSA)", "S. pneumoniae",
"V. cholerae", "HCV (Hep C)", "EBOV (Ebola)", "HIV-M", # "HFLUV (H1N1 2009)",
"HFLUV (H1N1)", "RABV", "FMDV", "P.falciparum (core)",    "P.falciparum (snp)", # "P.falciparum (ind)",
"P.falciparum (all)")
sppsubs$Group
sppsubs$Source
sppsubs$vartype
sppsubs$Label
sppsubs$Label <- factor(sppsubs$Label,levels=sppsubs$Label[order(sppsubs$Group,sppsubs$subrate_genome)],ordered=T)
pathOrder <- c("HCV","EBOV", "FMDV",   "HIV-M","HFLUV", "RABV",
"H. pylori", "S. aureus", "S. pneumoniae", "V. cholerae", "M. tuberculosis",
"P.falciparum")
sppsubs$Pathogen <- factor(sppsubs$Pathogen,levels=pathOrder,ordered=T)
gsizes <- seq(0,1e8,1e3)
rates <- data.frame("gsize"=gsizes,"years"=1/gsizes,"months"=12/gsizes,"weeks"=52/gsizes)
ratesM <- melt(rates,id.vars = "gsize",value.name ="subrate")
ratesM <- ratesM[ratesM$gsize>0,]
floors <- data.frame("gsize"=c(rep(max(ratesM$gsize),3),rep(min(ratesM$gsize),3)),
"variable"=unique(as.character(ratesM$variable)),
"subrate"=rep(0,6))
ratesM <- rbind(ratesM,floors)
ratesM$variable <- factor(ratesM$variable,levels=c("weeks","months","years"),ordered=T)
knit("evol_rate.Rmd")
